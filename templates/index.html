<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📺</text></svg>">
</head>
<body>
    <div class="app">
        <!-- ===== ヘッダー ===== -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">📺</span>
                <h1>YouTube Downloader</h1>
            </div>
            <p class="tagline">URLを貼り付けて、ワンクリックでダウンロード</p>
        </header>

        <main class="main">
            <!-- ===== URL 入力セクション ===== -->
            <section class="card" id="input-section">
                <div class="input-group">
                    <label for="url-input">YouTube URL</label>
                    <div class="input-row">
                        <input
                            type="url"
                            id="url-input"
                            class="text-input"
                            placeholder="https://www.youtube.com/watch?v=..."
                            autocomplete="off"
                            spellcheck="false"
                        >
                        <button id="paste-btn" class="icon-btn" title="クリップボードから貼り付け" aria-label="貼り付け">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                        </button>
                    </div>
                </div>

                <!-- フォーマット選択 -->
                <div class="format-group">
                    <label class="format-option">
                        <input type="radio" name="format" value="video" checked>
                        <span class="format-card">
                            <span class="format-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                            </span>
                            <span class="format-label">動画 (MP4)</span>
                        </span>
                    </label>
                    <label class="format-option">
                        <input type="radio" name="format" value="audio">
                        <span class="format-card">
                            <span class="format-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                            </span>
                            <span class="format-label">音声のみ (MP3)</span>
                        </span>
                    </label>
                </div>

                <!-- ダウンロードボタン -->
                <button id="download-btn" class="primary-btn" disabled>
                    <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span id="download-btn-text">ダウンロード</span>
                </button>
            </section>

            <!-- ===== 動画情報カード ===== -->
            <section class="card info-card hidden" id="info-section">
                <div class="video-preview">
                    <div class="thumbnail-wrap">
                        <img id="info-thumbnail" src="" alt="" class="thumbnail">
                        <span id="info-duration-badge" class="duration-badge">0:00</span>
                    </div>
                    <div class="video-meta">
                        <h3 id="info-title" class="video-title">-</h3>
                        <p id="info-channel" class="video-channel">-</p>
                        <p id="info-views" class="video-views">-</p>
                    </div>
                </div>
                <!-- 画質選択（動画のみ） -->
                <div id="quality-group" class="quality-group">
                    <label for="quality-select" class="quality-label">画質</label>
                    <select id="quality-select" class="quality-select">
                        <option value="1080">1080p (フルHD)</option>
                        <option value="720">720p (HD)</option>
                        <option value="480">480p</option>
                    </select>
                </div>
                <!-- 長すぎる警告 -->
                <div id="duration-warning" class="warning-banner hidden">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    <span>この動画は長時間です。ダウンロードに時間がかかる場合があります。</span>
                </div>
            </section>

            <!-- ===== 進捗カード ===== -->
            <section class="card progress-card hidden" id="progress-section">
                <div class="progress-title-row">
                    <span id="progress-status-icon" class="status-icon spinning">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                    </span>
                    <span id="progress-status-text">準備中...</span>
                </div>
                <p id="progress-video-title" class="progress-video-title"></p>
                <div class="progress-bar-wrap">
                    <div class="progress-bar-track">
                        <div id="progress-bar" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <span id="progress-percent" class="progress-percent">0%</span>
                </div>
                <div class="progress-stats">
                    <span id="progress-speed"></span>
                    <span id="progress-eta"></span>
                </div>
            </section>

            <!-- ===== ダウンロード準備完了カード ===== -->
            <section class="card ready-card hidden" id="ready-section">
                <div class="ready-icon-wrap">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                </div>
                <h3 class="ready-title">ダウンロード準備完了！</h3>
                <p id="ready-filename" class="ready-filename"></p>
                <p id="ready-filesize" class="ready-filesize"></p>
                <a id="save-btn" class="save-btn" href="#" download>
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span>ファイルを保存する</span>
                </a>
                <button id="another-btn" class="secondary-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    別の動画をダウンロード
                </button>
            </section>

            <!-- ===== エラーカード ===== -->
            <section class="card error-card hidden" id="error-section">
                <div class="error-icon-wrap">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                </div>
                <h3 class="error-title">エラーが発生しました</h3>
                <p id="error-message" class="error-message"></p>
                <button id="retry-btn" class="secondary-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    もう一度試す
                </button>
            </section>
        </main>

        <!-- ===== フッター ===== -->
        <footer class="footer">
            <p class="disclaimer">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                著作権に注意してご利用ください。個人利用の範囲でお楽しみください。
            </p>
        </footer>
    </div>

    <!-- トースト通知 -->
    <div id="toast-container" class="toast-container"></div>

    <script>
    /* =================================================================
       YouTube Downloader — Frontend Application
       ================================================================= */
    (() => {
        'use strict';

        // ----- DOM 要素 -----
        const $ = (sel) => document.querySelector(sel);
        const urlInput      = $('#url-input');
        const pasteBtn      = $('#paste-btn');
        const downloadBtn   = $('#download-btn');
        const downloadText  = $('#download-btn-text');
        const formatRadios  = document.querySelectorAll('input[name="format"]');
        const qualityGroup  = $('#quality-group');
        const qualitySelect = $('#quality-select');

        const infoSection     = $('#info-section');
        const progressSection = $('#progress-section');
        const readySection    = $('#ready-section');
        const errorSection    = $('#error-section');

        // ----- アプリ状態 -----
        let currentTaskId = null;
        let pollTimer = null;
        let infoDebounce = null;
        let videoInfo = null;

        // =============================================================
        //  初期化
        // =============================================================
        function init() {
            // サーバー起動チェック（Render cold start 対策）
            checkServer();

            // URL 入力イベント
            urlInput.addEventListener('input', onUrlInput);
            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') onDownloadClick();
            });

            // ボタンイベント
            pasteBtn.addEventListener('click', onPaste);
            downloadBtn.addEventListener('click', onDownloadClick);
            $('#retry-btn').addEventListener('click', onRetry);
            $('#another-btn').addEventListener('click', onReset);

            // フォーマット切替
            formatRadios.forEach((r) =>
                r.addEventListener('change', onFormatChange)
            );
        }

        async function checkServer() {
            try {
                const res = await fetch('/health');
                if (res.ok) return;
            } catch {
                showToast('サーバーに接続中...少々お待ちください', 'info', 5000);
                // リトライ
                await new Promise((r) => setTimeout(r, 3000));
                return checkServer();
            }
        }

        // =============================================================
        //  URL 入力 → 自動で動画情報を取得
        // =============================================================
        function onUrlInput() {
            const url = urlInput.value.trim();
            clearTimeout(infoDebounce);

            if (url && isYouTubeUrl(url)) {
                downloadBtn.disabled = false;
                infoDebounce = setTimeout(() => fetchVideoInfo(url), 600);
            } else {
                downloadBtn.disabled = true;
                hideSection(infoSection);
                videoInfo = null;
            }
        }

        function isYouTubeUrl(url) {
            return url.includes('youtube.com/') || url.includes('youtu.be/');
        }

        async function fetchVideoInfo(url) {
            try {
                infoSection.classList.remove('hidden');
                infoSection.classList.add('loading');

                const res = await fetch('/api/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }),
                });
                const data = await res.json();

                if (data.error) {
                    hideSection(infoSection);
                    return;
                }

                videoInfo = data;

                // UI 反映
                $('#info-thumbnail').src = data.thumbnail;
                $('#info-thumbnail').alt = data.title;
                $('#info-title').textContent = data.title;
                $('#info-channel').textContent = data.channel;
                $('#info-views').textContent = data.view_count
                    ? `${formatNumber(data.view_count)} 回視聴`
                    : '';
                $('#info-duration-badge').textContent = formatDuration(data.duration);

                // 画質セレクタを動的生成
                if (data.qualities && data.qualities.length) {
                    qualitySelect.innerHTML = data.qualities
                        .map((q) => `<option value="${q.value}">${q.label}</option>`)
                        .join('');
                }

                // 長時間警告
                if (data.too_long) {
                    $('#duration-warning').classList.remove('hidden');
                } else {
                    $('#duration-warning').classList.add('hidden');
                }

                infoSection.classList.remove('loading');
                onFormatChange(); // 画質グループの表示/非表示
            } catch (err) {
                console.error('Video info error:', err);
                hideSection(infoSection);
            }
        }

        // =============================================================
        //  フォーマット切替
        // =============================================================
        function onFormatChange() {
            const fmt = getSelectedFormat();
            if (fmt === 'audio') {
                qualityGroup.classList.add('hidden');
            } else {
                qualityGroup.classList.remove('hidden');
            }
        }

        function getSelectedFormat() {
            return document.querySelector('input[name="format"]:checked').value;
        }

        // =============================================================
        //  クリップボードから貼り付け
        // =============================================================
        async function onPaste() {
            try {
                const text = await navigator.clipboard.readText();
                urlInput.value = text;
                urlInput.dispatchEvent(new Event('input'));
                showToast('URLを貼り付けました', 'success');
            } catch {
                showToast(
                    'クリップボードにアクセスできません。手動で貼り付けてください。',
                    'error'
                );
            }
        }

        // =============================================================
        //  ダウンロード開始
        // =============================================================
        async function onDownloadClick() {
            const url = urlInput.value.trim();
            if (!url || !isYouTubeUrl(url)) {
                showToast('有効なYouTube URLを入力してください', 'error');
                return;
            }

            const fmt = getSelectedFormat();
            const quality = qualitySelect.value;

            // UI: 進捗表示に切り替え
            setInputLocked(true);
            hideSection(readySection);
            hideSection(errorSection);
            showSection(progressSection);

            resetProgress();
            if (videoInfo) {
                $('#progress-video-title').textContent = videoInfo.title || '';
            }

            try {
                const res = await fetch('/api/prepare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, format: fmt, quality }),
                });
                const data = await res.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                currentTaskId = data.task_id;
                startPolling();
            } catch (err) {
                showError('サーバーとの通信に失敗しました。再度お試しください。');
            }
        }

        // =============================================================
        //  進捗ポーリング
        // =============================================================
        function startPolling() {
            stopPolling();
            pollTimer = setInterval(pollProgress, 600);
        }

        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }

        async function pollProgress() {
            if (!currentTaskId) return;

            try {
                const res = await fetch(`/api/progress/${currentTaskId}`);
                const data = await res.json();

                if (data.error) {
                    stopPolling();
                    showError(data.error);
                    return;
                }

                updateProgressUI(data);

                if (data.status === 'ready') {
                    stopPolling();
                    showReady(data);
                } else if (data.status === 'error') {
                    stopPolling();
                    showError(data.message || 'ダウンロードに失敗しました');
                }
            } catch (err) {
                console.error('Polling error:', err);
            }
        }

        function updateProgressUI(data) {
            const bar = $('#progress-bar');
            const pct = $('#progress-percent');
            const status = $('#progress-status-text');
            const speed = $('#progress-speed');
            const eta = $('#progress-eta');

            bar.style.width = `${data.percent}%`;
            pct.textContent = `${data.percent}%`;

            switch (data.status) {
                case 'starting':
                    status.textContent = 'ダウンロードを準備中...';
                    break;
                case 'downloading':
                    status.textContent = 'ダウンロード中...';
                    speed.textContent = data.speed ? `速度: ${data.speed}` : '';
                    eta.textContent = data.eta ? `残り: ${data.eta}` : '';
                    break;
                case 'processing':
                    status.textContent = data.message || '変換処理中...';
                    speed.textContent = '';
                    eta.textContent = '';
                    break;
            }

            if (data.title && !$('#progress-video-title').textContent) {
                $('#progress-video-title').textContent = data.title;
            }
        }

        function resetProgress() {
            $('#progress-bar').style.width = '0%';
            $('#progress-percent').textContent = '0%';
            $('#progress-status-text').textContent = '準備中...';
            $('#progress-speed').textContent = '';
            $('#progress-eta').textContent = '';
            $('#progress-video-title').textContent = '';
        }

        // =============================================================
        //  ダウンロード準備完了
        // =============================================================
        function showReady(data) {
            hideSection(progressSection);
            showSection(readySection);

            $('#ready-filename').textContent = data.filename || '';
            $('#ready-filesize').textContent = data.filesize
                ? `ファイルサイズ: ${formatBytes(data.filesize)}`
                : '';

            const saveBtn = $('#save-btn');
            saveBtn.href = `/api/download/${currentTaskId}`;

            setInputLocked(false);
        }

        // =============================================================
        //  エラー表示
        // =============================================================
        function showError(message) {
            hideSection(progressSection);
            hideSection(readySection);
            showSection(errorSection);
            $('#error-message').textContent = message;
            setInputLocked(false);
        }

        // =============================================================
        //  リトライ・リセット
        // =============================================================
        function onRetry() {
            hideSection(errorSection);
            onDownloadClick();
        }

        function onReset() {
            stopPolling();
            currentTaskId = null;
            videoInfo = null;
            urlInput.value = '';
            hideSection(infoSection);
            hideSection(progressSection);
            hideSection(readySection);
            hideSection(errorSection);
            setInputLocked(false);
            downloadBtn.disabled = true;
            urlInput.focus();
        }

        // =============================================================
        //  UI ヘルパー
        // =============================================================
        function showSection(el) {
            el.classList.remove('hidden');
            // アニメーション用
            requestAnimationFrame(() => el.classList.add('visible'));
        }

        function hideSection(el) {
            el.classList.add('hidden');
            el.classList.remove('visible');
        }

        function setInputLocked(locked) {
            urlInput.disabled = locked;
            downloadBtn.disabled = locked;
            pasteBtn.disabled = locked;
            formatRadios.forEach((r) => (r.disabled = locked));
            qualitySelect.disabled = locked;

            if (locked) {
                downloadBtn.classList.add('loading');
                downloadText.textContent = 'ダウンロード中...';
            } else {
                downloadBtn.classList.remove('loading');
                downloadText.textContent = 'ダウンロード';
            }
        }

        // =============================================================
        //  トースト通知
        // =============================================================
        function showToast(message, type = 'info', duration = 3500) {
            const container = $('#toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // =============================================================
        //  フォーマットヘルパー
        // =============================================================
        function formatDuration(sec) {
            if (!sec) return '0:00';
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            if (h > 0) {
                return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }
            return `${m}:${String(s).padStart(2, '0')}`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${units[i]}`;
        }

        function formatNumber(num) {
            if (num >= 100_000_000) return `${(num / 100_000_000).toFixed(1)}億`;
            if (num >= 10_000) return `${(num / 10_000).toFixed(1)}万`;
            return num.toLocaleString('ja-JP');
        }

        // ----- 起動 -----
        init();
    })();
    </script>
</body>
</html>
